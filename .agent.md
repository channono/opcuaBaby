# .agent.md

This document guides AI assistants and contributors working on this repository. It summarizes project context, architecture, conventions, known pitfalls, and safe change patterns.

## Project overview

OPCUABaby is a desktop OPC UA client with:
- UI: built with Fyne (fyne.io/fyne/v2)
- OPC UA client wrapper: github.com/gopcua/opcua
- Embedded HTTP API + WebSocket server: Gin + Gorilla WebSocket

Primary modules:
- `internal/opc`: thin wrapper over gopcua client (connect, disconnect, read, write, browse, subscription handling)
- `internal/controller`: application core; orchestrates client lifecycle, watch list, address space cache, logs, API server lifecycle
- `internal/api`: Gin server for REST and WebSocket pub/sub hub
- `internal/ui`: Fyne app (tree view, watch list, node details, logs)
- `tools/`: helper utilities (e.g., SVG to PNG)

## Build & run

- Go toolchain required (see `go.mod` for version).
- Build: `go build ./...`
- Run app: `go run .`
- Config file: placed next to the executable as `opcuababy_config.json` (auto-created/updated by the app). Fields include OPC endpoint, security, API port, etc.

## Key runtime behaviors

- API server
  - REST endpoints under `/api/v1`:
    - `POST /api/v1/read` — read node attributes (requires `node_id`)
    - `POST /api/v1/write` — write value (requires `node_id`, `data_type`, `value`)
  - WebSocket endpoint `/ws/subscribe` — subscribe/unsubscribe to live updates.
  - When the OPC UA client is not connected, REST returns `503 Service Unavailable`; WS upgrade is rejected with 503.

- WebSocket hub lifecycle
  - Do NOT close `ApiBroadcastChan` from the controller. The hub observes the controller client context `.Done()` and proactively closes all WS clients.
  - The hub resets its broadcast channel by calling `controller.GetApiBroadcastChan()` instead of assuming ownership of closing.

- OPC UA write safety
  - Before writing, the controller reads the node attributes and uses server-reported `DataType` as the source of truth.
  - Supported data types include: boolean/bool, sbyte/byte, int16/uint16, int32/uint32, int64/uint64, float/double, string, and bytestring.
  - Bytestring input supported formats:
    - Hex with `0x` prefix (no spaces), e.g., `0x01AF`
    - Base64 (e.g., `QUJD`)
    - Raw string (treated as bytes)
  - Data type strings are normalized (case-insensitive, remove `ua:` prefix, spaces/underscores/hyphens, common aliases mapped).
  - If a node is not writable (no `Write` in `AccessLevel`), the controller logs this and write will likely fail with `StatusBadWriteNotSupported`.

- Subscriptions / watch list
  - `controller.AddWatch(nodeID)` adds a monitor (only if readable), caches a `WatchItem` and streams updates.
  - Remove operations (`RemoveWatch`, `RemoveAllWatches`) must notify UI via `OnWatchListUpdate` after modifying the map, and close underlying subscription handles outside locks.

## UI conventions

- Logs
  - Log messages can include color tags `[green] ... [-]`, `[yellow]`, `[red]` for on-screen coloring.
  - Copy-to-clipboard strips color tags; stored pure text is without `[color]` markers.
  - Each log line is shown as `[HH:MM:SS] message` with a trailing newline for line separation.

- Watch list
  - Double-click the Value column (twice within 300ms) opens the write dialog for that row (id.Row>0 and id.Col==3).
  - Value writes prefer server `DataType` fetched just-in-time.

- Theme and splitters
  - The app uses a compact theme for spacing, but defers most colors to Fyne defaults so it follows system Light/Dark variants.
  - Avoid overlaying split dividers with custom canvases (can hide content). Prefer theme tweaks or defaults.

## Known pitfalls and how to avoid them

- Panics on channel close
  - Do NOT close `ApiBroadcastChan` in the controller on disconnect.
  - The hub reads from the channel and controller context; it handles cleanup of WS clients.

- gopcua subscription goroutines
  - Do NOT manually close `dataChangeChan`. Let `sub.Cancel()` and the library manage channel lifecycle.
  - Always cancel subscription and client contexts to stop library goroutines before disposing.

- Write failures `StatusBadWriteNotSupported`
  - Usually indicates node is not writable or server requires a specific write contract. Inspect `AccessLevel`, `NodeClass`, `DataType`, and server doc.
  - Normalize and parse user input; for bytestring, support hex/base64/raw.

- DataType derived from UI metadata
  - The UI metadata stores `"AccessLevel, DataType"` and AccessLevel may include commas (e.g., `Read, Write`). Always pick the last fragment as DataType, or better, call `ReadNodeAttributes` before writes.

- Fyne theme overrides
  - Be cautious when overriding colors or adding overlays. Overlays can occlude Table content. If needed, adjust theme colors instead of stacking canvases above content.

## Code map (where to change what)

- API server: `internal/api/server.go`
  - REST handlers, WS hub (`Hub`), server bootstrap.
- Controller: `internal/controller/controller.go`
  - Client lifecycle, watch list management, logging, UI callbacks, API lifecycle.
  - Write normalization (`normalizeDataType`, `parseByteString`), write orchestration.
- OPC client wrapper: `internal/opc/*.go`
  - Connection, read/write, browse, subscription handling.
- UI: `internal/ui/ui.go`
  - Widgets, layout, callbacks, logs, write dialog, copy/clear logs, double-click behavior.

## Logging best practices

- Use `controller.Log("[green]message[-]")` or `[yellow]`, `[red]` as needed.
- Restrict log throughput using the built-in rate limiting in `Controller.Log`.
- When adding new log producers, prefer non-blocking sends to avoid contention.

## Error handling & HTTP status

- For REST during OPC disconnect: return `503 Service Unavailable` with JSON `{ "error": "OPC UA connection is not active" }`.
- For read errors indicating disconnect, map to 503 where applicable.

## Testing tips

- Minimal smoke test:
  - Launch app.
  - Connect to a reachable OPC UA endpoint (Anonymous is supported, other auth via config).
  - Browse root and a few nodes.
  - Add a variable node to watch and verify updates.
  - Test write dialog from the watch list (double-click value cell or Write button on a selected node).
  - Verify REST `POST /api/v1/read` and `/api/v1/write` and WS `/ws/subscribe`.

- Be mindful of server capabilities—some nodes are read-only; writes will fail as expected.

## Temporary files & scripts

- Name all temporary artifacts with prefix `tmp_rovodev_` and clean them up before finishing a task.

## Style & dependencies

- Go formatting: run `gofmt -w .` before building.
- Dependencies are managed via `go.mod` and `go.sum`.

## Common change patterns (safe diffs)

- Adding a new write type: extend `normalizeDataType` + write switch + value parser; keep UI read-before-write behavior.
- Extending logs: add new color tags only if UI `parseColorTags` supports them.
- Adjusting hub lifecycle: prefer context-driven cancellation over channel closing.

## When in doubt

- Prefer reading fresh node attributes before critical operations (writes or decisions based on datatype/access).
- Avoid closing or reassigning channels that other components may still use.
- Keep UI responsive by offloading network/IO work to goroutines and using `fyne.Do` to update UI.
